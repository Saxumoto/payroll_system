{% extends 'base.html' %}
{% block title %}Payroll Dashboard{% endblock %}

{% block content %}
<div class="dashboard-wrapper container py-4">

  <!-- Header with Filters and Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-white">Payroll Dashboard</h3>
    <div class="d-flex align-items-center">
      <form method="GET" class="d-flex align-items-center me-3">
        <label for="period" class="text-white me-2">Payroll Period:</label>
        <select name="period" id="period" class="form-select me-3" onchange="this.form.submit()">
          {% for period in periods %}
            <option value="{{ period }}" {% if period == selected_period %}selected{% endif %}>{{ period }}</option>
          {% endfor %}
        </select>
        <label for="department_filter" class="text-white me-2">Department:</label>
        <select name="department_filter" id="department_filter" class="form-select" onchange="this.form.submit()">
          <option value="">All</option>
          {% for dept in departments %}
            <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
          {% endfor %}
        </select>
      </form>
      <a href="/add" class="btn btn-success">+ Add Employee</a>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-4">
    {% for label, value in [
      ('Total Employee', total_employees),
      ('Total Payroll', total_payroll),
      ('Total Deduction', total_deduction),
      ('Net Pay', net_pay),
      ('Total Contribution', total_contribution),
      ('Total Loan', total_loan)
    ] %}
    <div class="col-md-4">
      <div class="card summary-card text-center">
        <div class="card-body">
          <h6>{{ label }}</h6>
          {% if label == 'Total Employee' %}
            <h2>{{ value or 0 }}</h2>
          {% else %}
            <h2>₱{{ "{:,.2f}".format(value or 0) }}</h2>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Employee Table -->
  <div class="mt-5">
    <h5 class="text-white mb-3">Employee Management</h5>
    <div class="card p-3">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-primary">
          <tr>
            <th>Name</th>
            <th>Position</th>
            <th>Department</th>
            <th>Salary</th>
            <th style="width: 240px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for emp in employees %}
          <tr>
            <td>{{ emp.name }}</td>
            <td>{{ emp.position }}</td>
            <td>{{ emp.department }}</td>
            <td>₱{{ "{:,.2f}".format(emp.salary or 0) }}</td>
            <td>
              <a href="/payroll/{{ emp.id }}/pdf" class="btn btn-sm btn-outline-secondary me-1">Payslip</a>
              <a href="/edit/{{ emp.id }}" class="btn btn-sm btn-outline-secondary me-1">Edit</a>
              <form action="{{ url_for('delete', emp_id=emp.id) }}" method="POST" class="d-inline-block">
                <button type="submit"
                            class="btn btn-sm btn-outline-secondary me-1"
                            onclick="return confirm('Delete {{ emp.name }}?')">
                    Delete
                </button>
                </form>
                
                <form action="{{ url_for('upload_attendance') }}" method="POST" enctype="multipart/form-data" class="mb-4">
                        <label for="attendance_file" class="form-label text-black">Upload Attendance CSV:</label>
                        <input type="file" name="attendance_file" id="attendance_file" class="form-control mb-2" accept=".csv" required>
                        <button type="submit" class="btn btn-sm btn-outline-secondary me-1">Import Attendance</button>
                </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted">No employees found for this period and department.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}